name: Deploy to OCI Functions (OCIR)

on:
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:

concurrency:
  group: deploy-oci-functions-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write  # needed for buildx cache type=gha

env:
  # ---------- OCIR ----------
  # Example: iad.ocir.io  (must match region of your Function)
  OCIR_REGISTRY: ${{ secrets.OCIR_REGION_KEY }}.ocir.io
  # Example: axxxxxx (Object Storage namespace / OCIR namespace)
  OCIR_NAMESPACE: ${{ secrets.OCIR_NAMESPACE }}
  # Example: reppy-worker (repository name under the namespace)
  OCIR_REPO: ${{ secrets.OCIR_REPO }}

  # ---------- OCI Functions ----------
  # OCI Region identifier, e.g. "us-ashburn-1"
  OCI_REGION: ${{ secrets.OCI_REGION }}
  # OCID of the target Function to update
  OCI_FUNCTION_OCID: ${{ secrets.OCI_FUNCTION_OCID }}

jobs:
  build-and-deploy:
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
      || (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::12}"
          IMAGE="${OCIR_REGISTRY}/${OCIR_NAMESPACE}/${OCIR_REPO}:${SHORT_SHA}"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to OCIR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.OCIR_REGISTRY }}
          # Username format: <ocir-namespace>/<user> (NOT email)
          username: ${{ secrets.OCIR_USERNAME }}
          # OCI Auth Token (not console password)
          password: ${{ secrets.OCIR_AUTH_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # OCI CLI 설치 + 인증 + 커맨드 실행을 한 번에 처리하는 Oracle 액션
      - name: Update OCI Function to new image
        uses: oracle-actions/run-oci-cli-command@v1.3.2
        env:
          OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_API_PRIVATE_KEY_PEM }}
          OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
        with:
          command: >
            fn function update
            --function-id "${{ env.OCI_FUNCTION_OCID }}"
            --image "${{ steps.meta.outputs.image }}"
            --wait-for-state ACTIVE

      - name: Output deployment info
        shell: bash
        run: |
          echo "Deployed: ${{ steps.meta.outputs.image }}"
