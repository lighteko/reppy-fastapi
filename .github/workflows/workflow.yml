name: Deploy to OCI Functions (OCIR)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-oci-functions-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  # ---------- OCIR ----------
  # Example: iad.ocir.io
  OCIR_REGISTRY: ${{ secrets.OCIR_REGION_KEY }}.ocir.io
  # Example: axxxxxx (Object Storage namespace / OCIR namespace)
  OCIR_NAMESPACE: ${{ secrets.OCIR_NAMESPACE }}
  # Example: reppy-worker (repository name under the namespace)
  OCIR_REPO: ${{ secrets.OCIR_REPO }}

  # ---------- OCI Functions ----------
  # OCI Region identifier, e.g. "us-ashburn-1"
  OCI_REGION: ${{ secrets.OCI_REGION }}
  # OCID of the target Function to update
  OCI_FUNCTION_OCID: ${{ secrets.OCI_FUNCTION_OCID }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image tag
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::12}"
          IMAGE="${OCIR_REGISTRY}/${OCIR_NAMESPACE}/${OCIR_REPO}:${SHORT_SHA}"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to OCIR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.OCIR_REGISTRY }}
          # Username format: <ocir-namespace>/<user> (NOT email). See OCI docs.
          username: ${{ secrets.OCIR_USERNAME }}
          # This should be an OCI Auth Token (not your console password)
          password: ${{ secrets.OCIR_AUTH_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install OCI CLI
        uses: oracle-actions/setup-oci-cli@v1.3.1
        with:
          version: "latest"

      - name: Configure OCI CLI (API key)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_API_PRIVATE_KEY_PEM }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${OCI_REGION}
          key_file=~/.oci/oci_api_key.pem
          EOF

      - name: Update OCI Function to new image
        shell: bash
        run: |
          set -euo pipefail
          echo "Deploying image: ${{ steps.meta.outputs.image }}"
          oci fn function update \
            --function-id "${OCI_FUNCTION_OCID}" \
            --image "${{ steps.meta.outputs.image }}" \
            --wait-for-state ACTIVE

      - name: Output deployment info
        run: |
          echo "Deployed: ${{ steps.meta.outputs.image }}"
